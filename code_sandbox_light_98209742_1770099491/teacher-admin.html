<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµì‚¬ ê´€ë¦¬ í˜ì´ì§€ - Level 5</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        .teacher-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 1rem;
            margin-bottom: 2rem;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .stat-box {
            background: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-box h3 {
            color: #667eea;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        .stat-box p {
            color: #6b7280;
            font-size: 0.9rem;
        }
        .students-table {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
        }
        tr:hover {
            background: #f9fafb;
        }
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }
        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }
        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }
        .export-btn {
            background: #10b981;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        .export-btn:hover {
            background: #059669;
        }
        .loading {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }
        .detail-btn {
            background: #667eea;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
        }
        .detail-btn:hover {
            background: #5568d3;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="logo">
                <i class="fas fa-graduation-cap"></i>
                <span>Level 5 Learning - êµì‚¬ ê´€ë¦¬</span>
            </div>
            <nav class="nav">
                <a href="index.html" class="nav-link">
                    <i class="fas fa-home"></i> í•™ìƒ í˜ì´ì§€
                </a>
            </nav>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <div class="teacher-header">
                <h1><i class="fas fa-chalkboard-teacher"></i> êµì‚¬ ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</h1>
                <p>í•™ìƒë“¤ì˜ í•™ìŠµ í˜„í™©ê³¼ ì„±ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
            </div>

            <!-- Overall Statistics -->
            <div class="stats-grid" id="statsGrid">
                <div class="stat-box">
                    <h3 id="totalStudents">-</h3>
                    <p>ì „ì²´ í•™ìƒ</p>
                </div>
                <div class="stat-box">
                    <h3 id="passedStudents">-</h3>
                    <p>AWL í†µê³¼</p>
                </div>
                <div class="stat-box">
                    <h3 id="totalWritings">-</h3>
                    <p>Writing ì œì¶œ</p>
                </div>
                <div class="stat-box">
                    <h3 id="totalGrammars">-</h3>
                    <p>ë¬¸ë²• ì›Œí¬ì‹œíŠ¸</p>
                </div>
                <div class="stat-box">
                    <h3 id="totalLogicMaps">-</h3>
                    <p>ë…¼ë¦¬êµ¬ì¡°ë„</p>
                </div>
            </div>
                <div class="stat-box">
                    <h3 id="avgScore">-</h3>
                    <p>í‰ê·  ì ìˆ˜</p>
                </div>
            </div>

            <!-- Export Button -->
            <button class="export-btn" onclick="exportToExcel()">
                <i class="fas fa-file-excel"></i> ì—‘ì…€ë¡œ ë‚´ë³´ë‚´ê¸°
            </button>

            <!-- Students Table -->
            <div class="students-table">
                <h2 style="margin-bottom: 1.5rem;">
                    <i class="fas fa-users"></i> í•™ìƒ ëª©ë¡
                </h2>
                <div id="loadingMessage" class="loading">
                    <i class="fas fa-spinner fa-spin"></i> ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                </div>
                <table id="studentsTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>ì´ë¦„</th>
                            <th>AWL ì ìˆ˜</th>
                            <th>ìƒíƒœ</th>
                            <th>Writing</th>
                            <th>ë¬¸ë²•</th>
                            <th>ë…¼ë¦¬êµ¬ì¡°ë„</th>
                            <th>ë§ˆì§€ë§‰ í™œë™</th>
                            <th>ìƒì„¸ë³´ê¸°</th>
                        </tr>
                    </thead>
                    <tbody id="studentsTableBody">
                    </tbody>
                </table>
                <div id="noDataMessage" style="display: none; text-align: center; padding: 2rem; color: #6b7280;">
                    <i class="fas fa-inbox"></i>
                    <p>ì•„ì§ í•™ìƒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    <p style="font-size: 0.875rem;">í•™ìƒë“¤ì´ í•™ìŠµì„ ì‹œì‘í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                </div>
            </div>

            <!-- Firebase Status -->
            <div style="text-align: center; margin-top: 2rem; padding: 1rem; background: #f9fafb; border-radius: 0.5rem;">
                <p id="firebaseStatus" style="color: #6b7280; font-size: 0.875rem;">
                    <i class="fas fa-database"></i> ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í™•ì¸ ì¤‘...
                </p>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2026 Level 5 Learning Platform. All rights reserved.</p>
        </div>
    </footer>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <script src="js/firebase-config.js"></script>
    <script>
        // Load data on page load
        document.addEventListener('DOMContentLoaded', async function() {
            checkFirebaseStatus();
            await loadAllData();
        });

        function checkFirebaseStatus() {
            const statusEl = document.getElementById('firebaseStatus');
            if (isFirebaseEnabled) {
                statusEl.innerHTML = '<i class="fas fa-check-circle" style="color: #10b981;"></i> Firebase ì—°ê²°ë¨ - ì‹¤ì‹œê°„ ë°ì´í„° ë™ê¸°í™”';
            } else {
                statusEl.innerHTML = '<i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i> Firebase ë¯¸ì—°ê²° - localStorage ì‚¬ìš© ì¤‘ (ë°ì´í„°ê°€ ì œí•œì ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤)';
            }
        }

        async function loadAllData() {
            try {
                // Get overall statistics
                const stats = await getOverallStatistics();
                if (stats) {
                    document.getElementById('totalStudents').textContent = stats.totalStudents;
                    document.getElementById('passedStudents').textContent = stats.passedStudents;
                    document.getElementById('totalWritings').textContent = stats.totalWritings || 0;
                    document.getElementById('totalGrammars').textContent = stats.totalGrammars || 0;
                    document.getElementById('totalLogicMaps').textContent = stats.totalLogicMaps || 0;
                }

                // Get all students
                const students = await getAllStudents();
                
                document.getElementById('loadingMessage').style.display = 'none';
                
                if (students.length === 0) {
                    document.getElementById('noDataMessage').style.display = 'block';
                } else {
                    document.getElementById('studentsTable').style.display = 'table';
                    displayStudents(students);
                }

            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loadingMessage').innerHTML = 
                    '<i class="fas fa-exclamation-circle"></i> ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
            }
        }

        async function displayStudents(students) {
            const tbody = document.getElementById('studentsTableBody');
            tbody.innerHTML = '';

            for (const student of students) {
                const row = document.createElement('tr');
                
                // AWL Status badge
                let statusBadge = '';
                if (student.awl_test_passed) {
                    statusBadge = `<span class="badge badge-success">âœ“ í•©ê²© (${student.awl_test_score}ì )</span>`;
                } else if (student.awl_test_score > 0) {
                    statusBadge = `<span class="badge badge-warning">ì¬ì‹œë„ (${student.awl_test_score}ì )</span>`;
                } else {
                    statusBadge = `<span class="badge badge-danger">ë¯¸ì‘ì‹œ</span>`;
                }

                // Get student test counts
                const writings = await getStudentWritings(student.id);
                const grammars = await getStudentGrammarWorksheets(student.id);
                const logicMaps = await getStudentLogicMaps(student.id);

                // Writing score display
                let writingDisplay = '-';
                if (writings.length > 0) {
                    const latestWriting = writings[0];
                    const score = latestWriting.score || 0;
                    const color = score >= 90 ? '#10b981' : score >= 80 ? '#f59e0b' : '#ef4444';
                    writingDisplay = `<span style="color: ${color}; font-weight: 600;">${score}ì </span>`;
                }

                // Grammar score display
                let grammarDisplay = '-';
                if (grammars.length > 0) {
                    const latestGrammar = grammars[0];
                    const score = latestGrammar.score || 0;
                    grammarDisplay = `${score}ì `;
                }

                row.innerHTML = `
                    <td><strong>${student.name}</strong></td>
                    <td>${student.awl_test_score || 0}ì </td>
                    <td>${statusBadge}</td>
                    <td>${writingDisplay}</td>
                    <td>${grammarDisplay}</td>
                    <td>${logicMaps.length > 0 ? logicMaps[0].score + '/8' : '-'}</td>
                    <td>${student.updated_at ? new Date(student.updated_at).toLocaleDateString() : '-'}</td>
                    <td>
                        <button class="detail-btn" onclick="viewStudentDetail('${student.id}', '${student.name}')">
                            <i class="fas fa-eye"></i> ìƒì„¸ë³´ê¸°
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            }
        }

        async function viewStudentDetail(studentId, studentName) {
            const awlTests = await getStudentAWLTests(studentId);
            const writings = await getStudentWritings(studentId);
            const grammars = await getStudentGrammarWorksheets(studentId);
            const dictations = await getStudentListeningDictations(studentId);
            const logicMaps = await getStudentLogicMaps(studentId);

            let message = `ğŸ“Š ${studentName} í•™ìƒ ìƒì„¸ ê¸°ë¡\n\n`;
            
            message += `ğŸ“ AWL í…ŒìŠ¤íŠ¸ (${awlTests.length}íšŒ):\n`;
            awlTests.forEach((test, index) => {
                message += `  ${index + 1}. ${test.score}ì  (${test.passed ? 'í•©ê²©' : 'ë¶ˆí•©ê²©'}) - ${new Date(test.date).toLocaleString()}\n`;
            });
            
            message += `\nâœï¸ Writing (${writings.length}íšŒ):\n`;
            writings.forEach((writing, index) => {
                const scoreStr = writing.score ? `${writing.score}ì ` : 'ì ìˆ˜ ì—†ìŒ';
                message += `  ${index + 1}. ${scoreStr} - ${new Date(writing.date).toLocaleString()}\n`;
                if (writing.detailedScores) {
                    message += `     ìƒì„¸: ê¸°ë³¸${writing.detailedScores.basic} ì‹œì œ${writing.detailedScores.tense} ìˆ˜ì¼ì¹˜${writing.detailedScores.agreement} ì—°ê²°ì‚¬${writing.detailedScores.connectors}\n`;
                }
            });
            
            message += `\nğŸ“š ë¬¸ë²• ì›Œí¬ì‹œíŠ¸ (${grammars.length}íšŒ):\n`;
            grammars.forEach((grammar, index) => {
                message += `  ${index + 1}. ${grammar.score || 0}ì  - ${new Date(grammar.date).toLocaleString()}\n`;
            });
            
            message += `\nğŸ§ ë¦¬ìŠ¤ë‹ ë”•í…Œì´ì…˜ (${dictations.length}íšŒ):\n`;
            dictations.forEach((dict, index) => {
                message += `  ${index + 1}. ${dict.score}/${dict.total} - ${new Date(dict.date).toLocaleString()}\n`;
            });
            
            message += `\nğŸ—ºï¸ ë…¼ë¦¬êµ¬ì¡°ë„ (${logicMaps.length}íšŒ):\n`;
            logicMaps.forEach((map, index) => {
                message += `  ${index + 1}. ${map.score}/8 - ${new Date(map.date).toLocaleString()}\n`;
            });

            alert(message);
        }

        function exportToExcel() {
            alert('ì—‘ì…€ ë‚´ë³´ë‚´ê¸° ê¸°ëŠ¥ì€ Firebase ì—°ë™ í›„ êµ¬í˜„ë©ë‹ˆë‹¤.\n\ní˜„ì¬ëŠ” Firebase Consoleì—ì„œ ì§ì ‘ ë°ì´í„°ë¥¼ ë‚´ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤:\n1. Firebase Console ì ‘ì†\n2. Firestore Database ì„ íƒ\n3. ë°ì´í„° ë‚´ë³´ë‚´ê¸°');
        }
    </script>
</body>
</html>
