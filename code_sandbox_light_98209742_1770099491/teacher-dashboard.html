<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµì‚¬ LMS ëŒ€ì‹œë³´ë“œ - Level 5 Learning</title>
    <link rel="stylesheet" href="css/brand-colors.css">
    <link rel="stylesheet" href="css/brand-fonts.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        body {
            background: var(--color-bg-main);
            font-family: var(--font-combined);
        }

        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* í—¤ë” */
        .teacher-header {
            background: var(--gradient-hero);
            color: white;
            padding: 2.5rem;
            border-radius: 1rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .teacher-header h1 {
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-bold);
            margin-bottom: 0.5rem;
        }

        .teacher-header p {
            font-size: var(--font-size-lg);
            opacity: 0.95;
        }

        .back-to-home {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 0.65rem 1.75rem;
            border-radius: 0.75rem;
            cursor: pointer;
            font-weight: var(--font-weight-medium);
            text-decoration: none;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .back-to-home:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        /* í†µê³„ ì¹´ë“œ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--color-bg-card);
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: var(--shadow-card);
            text-align: center;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
            border-color: var(--color-primary);
        }

        .stat-card i {
            font-size: 3rem;
            margin-bottom: 1rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-card .stat-value {
            font-size: var(--font-size-4xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-text-primary);
            margin-bottom: 0.5rem;
        }

        .stat-card .stat-label {
            font-size: var(--font-size-base);
            color: var(--color-text-secondary);
            font-weight: var(--font-weight-medium);
        }

        /* í•„í„° ì„¹ì…˜ */
        .filter-section {
            background: var(--color-bg-card);
            padding: 1.5rem;
            border-radius: 1rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-card);
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-input {
            flex: 1;
            min-width: 200px;
            padding: 0.75rem 1rem;
            border: 2px solid var(--color-border);
            border-radius: 0.5rem;
            font-family: var(--font-combined);
            font-size: var(--font-size-base);
            transition: all 0.3s ease;
        }

        .filter-input:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        .filter-select {
            padding: 0.75rem 1rem;
            border: 2px solid var(--color-border);
            border-radius: 0.5rem;
            font-family: var(--font-combined);
            font-size: var(--font-size-base);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        /* í•™ìƒ í…Œì´ë¸” */
        .students-table-section {
            background: var(--color-bg-card);
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: var(--shadow-card);
        }

        .students-table-section h2 {
            font-size: var(--font-size-2xl);
            color: var(--color-text-primary);
            margin-bottom: 1.5rem;
        }

        .students-table {
            width: 100%;
            border-collapse: collapse;
        }

        .students-table thead {
            background: var(--color-bg-light);
        }

        .students-table th {
            padding: 1rem;
            text-align: left;
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            border-bottom: 2px solid var(--color-border);
        }

        .students-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--color-border-light);
            color: var(--color-text-secondary);
        }

        .students-table tbody tr {
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .students-table tbody tr:hover {
            background: var(--color-bg-light);
        }

        .progress-badge {
            display: inline-block;
            padding: 0.35rem 0.85rem;
            border-radius: 1rem;
            font-size: 0.85rem;
            font-weight: var(--font-weight-semibold);
        }

        .badge-green {
            background: var(--color-success-light);
            color: var(--color-success-dark);
        }

        .badge-yellow {
            background: var(--color-warning-light);
            color: var(--color-warning-dark);
        }

        .badge-red {
            background: var(--color-danger-light);
            color: var(--color-danger-dark);
        }

        .badge-gray {
            background: var(--color-bg-light);
            color: var(--color-text-tertiary);
        }

        .view-detail-btn {
            background: var(--color-primary);
            color: white;
            border: none;
            padding: 0.5rem 1.25rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: var(--font-weight-medium);
            transition: all 0.2s ease;
        }

        .view-detail-btn:hover {
            background: var(--color-primary-dark);
            transform: translateY(-2px);
        }

        /* ë¡œë”© ìƒíƒœ */
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--color-text-secondary);
        }

        .loading i {
            font-size: 3rem;
            animation: spin 1s linear infinite;
            color: var(--color-primary);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--color-text-tertiary);
        }

        .empty-state i {
            font-size: 5rem;
            margin-bottom: 1.5rem;
            opacity: 0.2;
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .dashboard-container {
                padding: 1rem;
            }

            .teacher-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .students-table {
                font-size: 0.9rem;
            }

            .students-table th,
            .students-table td {
                padding: 0.75rem 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        
        <!-- ë¡œë”© ìƒíƒœ -->
        <div id="loadingState" class="loading">
            <i class="fas fa-spinner"></i>
            <p>í•™ìƒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>

        <!-- ë©”ì¸ ëŒ€ì‹œë³´ë“œ (ì´ˆê¸° ìˆ¨ê¹€) -->
        <div id="mainDashboard" style="display: none;">
            
            <!-- êµì‚¬ í—¤ë” -->
            <div class="teacher-header">
                <div>
                    <h1><i class="fas fa-chalkboard-teacher"></i> êµì‚¬ LMS ëŒ€ì‹œë³´ë“œ</h1>
                    <p>Level 5 í•™ìƒ ê´€ë¦¬ ë° ì§„ë„ í˜„í™©</p>
                </div>
                <div>
                    <a href="index.html" class="back-to-home">
                        <i class="fas fa-home"></i> í™ˆìœ¼ë¡œ
                    </a>
                </div>
            </div>

            <!-- í†µê³„ ì¹´ë“œ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <i class="fas fa-users"></i>
                    <div class="stat-value" id="totalStudents">0</div>
                    <div class="stat-label">ì „ì²´ í•™ìƒ ìˆ˜</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-chart-line"></i>
                    <div class="stat-value" id="averageProgress">Day 0</div>
                    <div class="stat-label">í‰ê·  ì§„ë„</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-star"></i>
                    <div class="stat-value" id="averageScore">0ì </div>
                    <div class="stat-label">í‰ê·  ì ìˆ˜</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-tasks"></i>
                    <div class="stat-value" id="totalTasks">0</div>
                    <div class="stat-label">ë°°ì •ëœ ê³¼ì œ</div>
                </div>
            </div>

            <!-- í•„í„° ì„¹ì…˜ -->
            <div class="filter-section">
                <input 
                    type="text" 
                    class="filter-input" 
                    id="searchInput" 
                    placeholder="ğŸ” í•™ìƒ ì´ë¦„ ê²€ìƒ‰..."
                    onkeyup="filterStudents()"
                >
                <select class="filter-select" id="progressFilter" onchange="filterStudents()">
                    <option value="all">ì „ì²´ ì§„ë„</option>
                    <option value="ahead">ì•ì„œê°€ëŠ” í•™ìƒ (Day 10+)</option>
                    <option value="ontrack">ì •ìƒ ì§„í–‰ (Day 1-9)</option>
                    <option value="behind">ë¶€ì§„ í•™ìƒ (Day 0)</option>
                </select>
                <select class="filter-select" id="statusFilter" onchange="filterStudents()">
                    <option value="all">ì „ì²´ ìƒíƒœ</option>
                    <option value="active">í™œë™ ì¤‘</option>
                    <option value="inactive">ë¯¸í™œë™</option>
                </select>
            </div>

            <!-- í•™ìƒ ëª©ë¡ í…Œì´ë¸” -->
            <div class="students-table-section">
                <h2>ğŸ“‹ í•™ìƒ ëª©ë¡</h2>
                <div id="studentsTableContainer">
                    <!-- í…Œì´ë¸”ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                </div>
            </div>

        </div>

    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="js/progress-manager.js"></script>

    <script>
        let allStudents = [];
        let filteredStudents = [];

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // ëª¨ë“  í•™ìƒ ë°ì´í„° ë¡œë“œ
                await loadAllStudents();
                
                // í†µê³„ ì—…ë°ì´íŠ¸
                updateStatistics();
                
                // í•™ìƒ í…Œì´ë¸” ë Œë”ë§
                renderStudentsTable();

                // ë¡œë”© ìˆ¨ê¸°ê¸°, ë©”ì¸ í‘œì‹œ
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('mainDashboard').style.display = 'block';

            } catch (error) {
                console.error('âŒ Dashboard initialization error:', error);
                document.getElementById('loadingState').innerHTML = `
                    <i class="fas fa-exclamation-triangle" style="color: var(--color-danger);"></i>
                    <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
                    <button onclick="location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: var(--color-primary); color: white; border: none; border-radius: 0.5rem; cursor: pointer;">
                        ë‹¤ì‹œ ì‹œë„
                    </button>
                `;
            }
        });

        // ëª¨ë“  í•™ìƒ ë°ì´í„° ë¡œë“œ
        async function loadAllStudents() {
            const db = firebase.firestore();
            const snapshot = await db.collection('student_progress').get();
            
            allStudents = [];
            snapshot.forEach(doc => {
                allStudents.push({
                    id: doc.id,
                    ...doc.data()
                });
            });

            filteredStudents = [...allStudents];
            console.log('âœ… Loaded students:', allStudents.length);
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStatistics() {
            const totalStudents = allStudents.length;
            document.getElementById('totalStudents').textContent = totalStudents;

            if (totalStudents === 0) {
                document.getElementById('averageProgress').textContent = 'Day 0';
                document.getElementById('averageScore').textContent = '0ì ';
                document.getElementById('totalTasks').textContent = '0';
                return;
            }

            // í‰ê·  ì§„ë„ ê³„ì‚°
            const avgDay = Math.round(
                allStudents.reduce((sum, student) => sum + student.currentDay, 0) / totalStudents
            );
            document.getElementById('averageProgress').textContent = `Day ${avgDay}`;

            // í‰ê·  ì ìˆ˜ ê³„ì‚°
            const studentsWithScores = allStudents.filter(s => {
                const stats = ProgressManager.calculateStudentStats(s);
                return stats.averageScore > 0;
            });

            if (studentsWithScores.length > 0) {
                const avgScore = Math.round(
                    studentsWithScores.reduce((sum, student) => {
                        const stats = ProgressManager.calculateStudentStats(student);
                        return sum + stats.averageScore;
                    }, 0) / studentsWithScores.length
                );
                document.getElementById('averageScore').textContent = `${avgScore}ì `;
            } else {
                document.getElementById('averageScore').textContent = '-';
            }

            // ê°œë³„ê³¼ì œ ìˆ˜ (ì•„ì§ êµ¬í˜„ ì•ˆ ë¨)
            document.getElementById('totalTasks').textContent = '0';
        }

        // í•™ìƒ í…Œì´ë¸” ë Œë”ë§
        function renderStudentsTable() {
            const container = document.getElementById('studentsTableContainer');

            if (filteredStudents.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-user-slash"></i>
                        <p>í‘œì‹œí•  í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤</p>
                    </div>
                `;
                return;
            }

            let html = `
                <table class="students-table">
                    <thead>
                        <tr>
                            <th>ì´ë¦„</th>
                            <th>í˜„ì¬ ì§„ë„</th>
                            <th>ì™„ë£Œí•œ Day</th>
                            <th>í‰ê·  ì ìˆ˜</th>
                            <th>ìƒíƒœ</th>
                            <th>ìƒì„¸ë³´ê¸°</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            filteredStudents.forEach(student => {
                const completedDays = student.completedDays.length;
                const stats = ProgressManager.calculateStudentStats(student);
                const avgScore = stats.averageScore > 0 ? `${stats.averageScore}ì ` : '-';
                
                let progressBadge = 'badge-green';
                let progressText = 'ì •ìƒ';
                if (student.currentDay === 1 && completedDays === 0) {
                    progressBadge = 'badge-yellow';
                    progressText = 'ì‹œì‘';
                } else if (student.currentDay >= 10) {
                    progressBadge = 'badge-green';
                    progressText = 'ìš°ìˆ˜';
                }

                html += `
                    <tr onclick="viewStudentDetail('${student.id}')">
                        <td><strong>${student.studentName}</strong></td>
                        <td>Day ${student.currentDay} / 96</td>
                        <td>${completedDays}ê°œ ì™„ë£Œ</td>
                        <td>${avgScore}</td>
                        <td><span class="progress-badge ${progressBadge}">${progressText}</span></td>
                        <td>
                            <button class="view-detail-btn" onclick="event.stopPropagation(); viewStudentDetail('${student.id}')">
                                <i class="fas fa-eye"></i> ë³´ê¸°
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        // í•™ìƒ í•„í„°ë§
        function filterStudents() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const progressFilter = document.getElementById('progressFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            filteredStudents = allStudents.filter(student => {
                // ì´ë¦„ ê²€ìƒ‰
                if (searchTerm && !student.studentName.toLowerCase().includes(searchTerm)) {
                    return false;
                }

                // ì§„ë„ í•„í„°
                if (progressFilter !== 'all') {
                    if (progressFilter === 'ahead' && student.currentDay < 10) return false;
                    if (progressFilter === 'ontrack' && (student.currentDay < 1 || student.currentDay >= 10)) return false;
                    if (progressFilter === 'behind' && student.currentDay > 0) return false;
                }

                // ìƒíƒœ í•„í„° (í™œë™/ë¯¸í™œë™)
                if (statusFilter !== 'all') {
                    const lastActive = student.updated_at || student.created_at;
                    const threeDaysAgo = Date.now() - (3 * 24 * 60 * 60 * 1000);
                    const isActive = lastActive > threeDaysAgo;

                    if (statusFilter === 'active' && !isActive) return false;
                    if (statusFilter === 'inactive' && isActive) return false;
                }

                return true;
            });

            renderStudentsTable();
        }

        // í•™ìƒ ìƒì„¸ë³´ê¸°
        function viewStudentDetail(studentId) {
            window.location.href = `student-detail.html?studentId=${studentId}`;
        }
    </script>
</body>
</html>
